<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meow-Mate - My Cart</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { background-color: #f8f9fa; }
  h3, h4 { color: #4b3e8f; }
  .card-custom {
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .card-custom:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
  .btn-remove { font-size: 0.8rem; }
  .badge-status { font-size: 0.85rem; }
  .card-body-small { font-size: 0.9rem; color: #555; }
</style>
</head>
<body class="p-4">

<h3 class="mb-4">ðŸ›’ My Cart</h3>
<div id="cart-content" class="mb-4"></div>
<div class="d-flex justify-content-between align-items-center mb-5">
  <div class="fw-bold" id="cartSummary">Total Items: 0 | Subtotal: $0.00</div>
  <button class="btn btn-success btn-lg" id="checkoutBtn"><i class="fas fa-credit-card me-2"></i> Checkout</button>
</div>

<hr class="my-4"/>

<h4 class="mb-4">ðŸ“¦ My Orders</h4>
<div id="orders-content"></div>

<script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
<script>
if (!window.__MEOWMATE_MYCART_LOADED__) {
window.__MEOWMATE_MYCART_LOADED__ = true;

let cart = JSON.parse(localStorage.getItem('myCart') || '[]');

function calcCartTotals(){
  let items = 0; let subtotal = 0;
  cart.forEach(c => { items += c.quantity || 1; subtotal += (c.price * (c.quantity||1)); });
  return {items, subtotal};
}

function updateCart() { 
  localStorage.setItem('myCart', JSON.stringify(cart)); 
  const container = document.getElementById('cart-content');
  if(!container) return;

  container.innerHTML = '';
  if(cart.length === 0) {
    container.innerHTML = '<p class="text-muted">Cart is empty</p>';
  } else {
    cart.forEach((c, i) => {
      const qty = c.quantity || 1;
      const lineTotal = (c.price * qty).toFixed(2);
      const div = document.createElement('div');
      div.className = 'card card-custom p-3 mb-3';
      div.innerHTML = `
        <div class="row g-2 align-items-center">
          <div class="col-md-4">
            <h5 class="mb-1">${c.name}</h5>
            <p class="mb-0 text-muted">Unit: $${c.price}</p>
          </div>
          <div class="col-md-3 d-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="changeQty(${i}, -1)"><i class="fas fa-minus"></i></button>
            <input type="number" min="1" class="form-control form-control-sm text-center" style="max-width:70px" value="${qty}" onchange="setQty(${i}, this.value)">
            <button class="btn btn-outline-secondary btn-sm" onclick="changeQty(${i}, 1)"><i class="fas fa-plus"></i></button>
          </div>
          <div class="col-md-3 fw-semibold">Line Total: $${lineTotal}</div>
          <div class="col-md-2 text-end">
            <button class="btn btn-danger btn-remove" onclick="removeFromCart(${i})"><i class="fas fa-trash-alt"></i></button>
          </div>
        </div>`;
      container.appendChild(div);
    });
  }
  const summary = calcCartTotals();
  document.getElementById('cartSummary').textContent = `Total Items: ${summary.items} | Subtotal: $${summary.subtotal.toFixed(2)}`;
}

function removeFromCart(index) { cart.splice(index, 1); updateCart(); }

function changeQty(index, delta){
  const item = cart[index]; if(!item) return; if(!item.quantity) item.quantity = 1;
  item.quantity += delta; if(item.quantity < 1) item.quantity = 1; updateCart();
}
function setQty(index, value){
  let v = parseInt(value)||1; if(v<1) v=1; cart[index].quantity = v; updateCart();
}

function decodeUserId() {
  const token = localStorage.getItem('accessToken');
  if(!token) return null;
  try { return jwt_decode(token).userId; } catch(e) { return null; }
}

async function loadMyOrders() {
  const userId = decodeUserId();
  const ordersDiv = document.getElementById('orders-content');
  if(!ordersDiv) return;

  if(!userId) { 
    ordersDiv.innerHTML = '<p class="text-muted">Login to see your orders.</p>'; 
    return; 
  }

  ordersDiv.innerHTML = '<p class="text-muted">Loading ordersâ€¦</p>';

  try {
    const resp = await fetch(`http://localhost:8080/api/orders/user/${userId}`);
    if(!resp.ok) throw new Error('Failed to fetch orders');
    const orders = await resp.json();
    const uidNum = Number(userId);
    const filtered = Array.isArray(orders) ? orders.filter(o => (Number(o?.user?.id ?? o?.user?.userId) === uidNum)) : [];

    if(filtered.length === 0){ 
      ordersDiv.innerHTML = '<p class="text-muted">No orders yet.</p>'; 
      return; 
    }

    ordersDiv.innerHTML = '';
    filtered.reverse().forEach(o => {
      const li = document.createElement('div');
      li.className = 'card card-custom p-3 mb-3';
      const itemName = o.items?.listingName ?? 'Item';
      const qty = o.quantity ?? 1;
      const total = o.total ?? o.unitPrice ?? '0';
      const status = o.status ?? 'PAID';
      const when = o.createdAt ? new Date(o.createdAt).toLocaleString() : '';
      li.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h5 class="mb-1">${itemName}</h5>
            <p class="card-body-small mb-1">Qty: ${qty} | Total: $${total}</p>
            <p class="card-body-small mb-0 text-muted">${when}</p>
          </div>
          <span class="badge bg-primary badge-status">${status}</span>
        </div>
      `;
      ordersDiv.appendChild(li);
    });

  } catch(err) {
    console.warn('Could not load orders', err);
    ordersDiv.innerHTML = '<p class="text-danger">Failed to load orders.</p>';
  }
}

function checkoutCart() {
  if(cart.length === 0){ alert('Cart is empty'); return; }
  const token = localStorage.getItem('accessToken'); 
  if(!token){ alert('Login required'); return; }
  const decoded = jwt_decode(token); const userId = decoded.userId;

  (async ()=>{
    for(const c of cart){
      const qty = c.quantity || 1;
      await fetch(`http://localhost:8080/api/orders/create?userId=${userId}&listingId=${c.id}&quantity=${qty}`, {method:'POST'});
      const paymentPayload = { listingName: c.name, quantity: qty, price: String((c.price * qty).toFixed(2)) };
      await fetch('http://localhost:8080/api/payments/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(paymentPayload)
      });
      // decrease stock per quantity (assuming backend decreases by 1 each call)
      for(let i=0;i<qty;i++) {
        await fetch(`http://localhost:8080/api/items/${c.id}/decrease`, { method:'PUT' });
      }
    }
    alert('All items purchased successfully');
    cart = []; updateCart();
    loadMyOrders();
  })();
}

updateCart();
document.getElementById('checkoutBtn')?.addEventListener('click', checkoutCart);
loadMyOrders();

} // END guard
</script>
</body>
</html>
